{"version":3,"sources":["../index.js"],"names":["entries","pkg","key","entry","Object","name","version","matchAll","getRootPackageName","satisfies","allowed","originalPkg","cloneDeep","obj","pick","merge","before","after","shouldPrintDiff","printDiff","debug","pjson","require","process","cwd","delta","str","map","part","color","added","removed","value","join","length"],"mappings":";;;;;;kBAae,UAASA,OAAT,EAAkB;AAC/B,SAAO,UAASC,GAAT,EAAc;AACnB,SAAK,MAAM,CAACC,GAAD,EAAMC,KAAN,CAAX,IAA2BC,OAAOJ,OAAP,CAAeA,OAAf,CAA3B,EAAoD;AAClD,UAAI,EAACK,IAAD,EAAOC,OAAP,KAAkB,gCAAiBJ,GAAjB,CAAtB;AACA;AACA;AACA,UAAIK,WAAW,KAAf;AACA,UAAID,YAAY,EAAhB,EAAoBC,WAAW,IAAX;AACpB,UAAIL,QAAQ,QAAZ,EAAsB;AACpBG,eAAOG,oBAAP;AACD;;AAED;AACA,UAAIH,SAASJ,IAAII,IAAjB,EAAuB;AACrB,YAAIE,YAAY,iBAAOE,SAAP,CAAiBR,IAAIK,OAArB,EAA8BA,OAA9B,CAAhB,EAAwD;AACtD,gBAAMI,UAAU,CACd,cADc,EAEd,iBAFc,EAGd,kBAHc,CAAhB;AAKA,gBAAMC,cAAc,iBAAEC,SAAF,CAAYX,GAAZ,CAApB;AACA,gBAAMY,MAAM,iBAAEC,IAAF,CAAOX,KAAP,EAAcO,OAAd,CAAZ;AACA,2BAAEK,KAAF,CAAQd,GAAR,EAAaY,GAAb,EARsD,CAQpC;AAClB,gBAAMG,SAAS,iBAAEF,IAAF,CAAOH,WAAP,EAAoBD,OAApB,CAAf;AACA,gBAAMO,QAAQ,iBAAEH,IAAF,CAAOb,GAAP,EAAYS,OAAZ,CAAd;AACA,cAAIQ,eAAJ,EAAqBC,UAAUlB,GAAV,EAAee,MAAf,EAAuBC,KAAvB;;AAErB;AACA;AACD;AACF;AACF;AACF,GA/BD;AAgCD,C;;AA9CD;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;AAEA,MAAMG,QAAQ,qBAAM,4BAAN,CAAd;;AAEA;AACA,MAAMF,kBAAkB,IAAxB;;AAqCA,SAASV,kBAAT,GAA8B;AAC5B,QAAMa,QAAQC,QAAQ,gBAAKC,QAAQC,GAAR,EAAL,EAAoB,cAApB,CAAR,CAAd;AACA,SAAOH,MAAMhB,IAAb;AACD;;AAED,SAASc,SAAT,CAAmBlB,GAAnB,EAAwBe,MAAxB,EAAgCC,KAAhC,EAAuC;AACrC,QAAMQ,QAAQ,oBAAST,MAAT,EAAiBC,KAAjB,CAAd;AACA,QAAMS,MAAMD,MAAME,GAAN,CAAUC,QAAQ;AAC5B,QAAIC,QAAQD,KAAKE,KAAL,GAAa,OAAb,GAAuBF,KAAKG,OAAL,GAAe,KAAf,GAAuB,MAA1D;AACA,WAAO,gBAAMF,KAAN,EAAaD,KAAKI,KAAlB,CAAP;AACD,GAHW,EAGTC,IAHS,CAGJ,EAHI,CAAZ;AAIA,MAAIR,MAAMS,MAAV,EAAkB;AAChBd,UAAO,aAAYnB,IAAII,IAAK,GAA5B;AACAe,UAAMM,GAAN;AACD;AACF","file":"index.js","sourcesContent":["import semver from 'semver'\nimport parsePackageName from 'parse-package-name'\nimport path, {join} from 'path'\nimport _ from 'lodash'\nimport Debug from 'debug'\nimport {diffJson} from 'diff'\nimport chalk from 'chalk'\n\nconst debug = Debug('pnpmfile-read-package-json')\n\n// Using `debug`.\nconst shouldPrintDiff = true\n\nexport default function(entries) {\n  return function(pkg) {\n    for (const [key, entry] of Object.entries(entries)) {\n      let {name, version} = parsePackageName(key)\n      // TODO(vjpr): '' is a valid range I think according to https://semver.npmjs.com/.\n      // TODO(vjpr): '' and '*' never match pre-release versions. Should we introduce syntax to match all versions including pre-release?\n      let matchAll = false\n      if (version === '') matchAll = true\n      if (key === '<root>') {\n        name = getRootPackageName()\n      }\n\n      // TODO(vjpr): We need to find the best version to replace. Maybe sort by semver beforehand.\n      if (name === pkg.name) {\n        if (matchAll || semver.satisfies(pkg.version, version)) {\n          const allowed = [\n            'dependencies',\n            'devDependencies',\n            'peerDependencies',\n          ]\n          const originalPkg = _.cloneDeep(pkg)\n          const obj = _.pick(entry, allowed)\n          _.merge(pkg, obj) // Mutates!\n          const before = _.pick(originalPkg, allowed)\n          const after = _.pick(pkg, allowed)\n          if (shouldPrintDiff) printDiff(pkg, before, after)\n\n          // TODO(vjpr): Support callback function for custom changes.\n          break\n        }\n      }\n    }\n  }\n}\n\nfunction getRootPackageName() {\n  const pjson = require(join(process.cwd(), 'package.json'))\n  return pjson.name\n}\n\nfunction printDiff(pkg, before, after) {\n  const delta = diffJson(before, after)\n  const str = delta.map(part => {\n    var color = part.added ? 'green' : part.removed ? 'red' : 'grey'\n    return chalk[color](part.value)\n  }).join('')\n  if (delta.length) {\n    debug(`Modified '${pkg.name}'`)\n    debug(str)\n  }\n}\n"]}